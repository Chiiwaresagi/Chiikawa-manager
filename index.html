<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¹˜ì´ì¹´ì™€ ê³µêµ¬ ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        :root {
            --chii-pink: #FFB7B2;
            --chii-dark-pink: #FF9AA2;
            --bg-color: #FFF8F9;
        }

        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: #4A4A4A; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #fff; }
        ::-webkit-scrollbar-thumb { background: var(--chii-pink); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--chii-dark-pink); }

        .card-shadow { box-shadow: 4px 4px 0px var(--chii-pink); border: 2px solid #6D6D6D; }
        .receipt-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* ì…ë ¥ ê·¸ë£¹ ë””ìì¸ */
        .input-group {
            display: flex;
            align-items: center;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            overflow: hidden;
            background-color: #FFF;
            transition: all 0.2s;
            width: 100%;
            position: relative;
        }
        .input-group:focus-within {
            border-color: var(--chii-dark-pink);
            box-shadow: 0 0 0 3px rgba(255, 154, 162, 0.2);
        }
        /* ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤íƒ€ì¼ */
        .input-group.error {
            border-color: #EF4444 !important;
            background-color: #FEF2F2;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .input-group input {
            flex: 1;
            border: none;
            padding: 10px;
            outline: none;
            min-width: 0; 
            background: transparent;
            font-size: 14px;
        }
        .input-group span {
            background-color: #F3F4F6;
            padding: 10px;
            color: #6B7280;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            border-left: 1px solid #E5E7EB;
        }

        .btn-bounce { transition: transform 0.1s; }
        .btn-bounce:active { transform: scale(0.95); }

        .mobile-sticky-bar { 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .receipt-paper {
            background-image: radial-gradient(#F3F4F6 1px, transparent 0);
            background-size: 10px 10px;
        }
        
        .safe-bottom-padding { padding-bottom: 200px !important; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden selection:bg-pink-100 selection:text-pink-600">

    <header class="bg-white/95 backdrop-blur-md border-b border-pink-100 z-40 px-4 py-3 flex-none">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center gap-2">
                    <div class="w-9 h-9 bg-pink-100 rounded-full flex items-center justify-center text-pink-500 text-lg border-2 border-pink-200">
                        <i class="fa-solid fa-heart"></i>
                    </div>
                    <h1 class="text-xl font-black text-gray-700 tracking-tight">ì¹˜ì´ì¹´ì™€ ê³µêµ¬</h1>
                </div>
                
                <div class="bg-yellow-50 px-3 py-1.5 rounded-full border border-yellow-200 flex items-center shadow-sm">
                    <span class="text-xs font-bold text-yellow-600 mr-2">í™˜ìœ¨</span>
                    <input type="number" id="exchangeRate" value="900" class="bg-transparent w-12 text-right font-bold text-gray-700 outline-none border-b border-yellow-300 focus:border-yellow-500 text-sm" oninput="calculateAll()">
                </div>
            </div>
            
            <div class="hidden md:flex gap-2">
                <button onclick="saveData()" class="btn-bounce bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-green-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-download"></i> ì €ì¥
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-bounce bg-blue-100 text-blue-700 border border-blue-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-folder-open"></i> ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadData(this)">
            </div>
        </div>
    </header>

    <div class="md:hidden flex gap-2 p-2 bg-white border-b border-gray-100 justify-end flex-none z-30">
        <button onclick="saveData()" class="text-xs bg-green-50 text-green-600 px-3 py-1.5 rounded-lg border border-green-100 font-bold">
            <i class="fa-solid fa-download"></i> ì €ì¥
        </button>
        <button onclick="document.getElementById('fileInput').click()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg border border-blue-100 font-bold">
            <i class="fa-solid fa-folder-open"></i> ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
    </div>

    <div class="flex-grow flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto w-full relative">
        
        <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 safe-bottom-padding md:pb-6" id="main-scroll">
            <div id="cartsContainer" class="space-y-6 md:space-y-8"></div>
            
            <div class="text-center">
                <button onclick="addCart()" class="btn-bounce w-full md:w-2/3 mx-auto bg-white border-2 border-dashed border-pink-200 text-pink-400 px-6 py-5 rounded-3xl hover:bg-pink-50 hover:border-pink-300 transition font-bold text-lg shadow-sm flex flex-col items-center gap-2">
                    <i class="fa-solid fa-circle-plus text-2xl"></i>
                    <span>ìƒˆë¡œìš´ ì¹´íŠ¸ ì¶”ê°€</span>
                </button>
            </div>
        </main>

        <aside class="hidden lg:flex w-[380px] bg-white border-l border-gray-100 flex-col shadow-2xl z-20">
            <div class="p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-blue-400"></i> ì •ì‚° ë‚´ì—­ì„œ
                    </h2>
                    <p class="text-xs text-gray-400 mt-1">ì´ë¦„ ë’¤ì— ìˆ«ìë¡œ ìˆ˜ëŸ‰ ì§€ì • (ì˜ˆ: ë†ë‹´ê³°2)</p>
                </div>
                <button onclick="copyToClipboard()" class="btn-bounce bg-gray-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-900 shadow-lg flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> ë³µì‚¬
                </button>
            </div>
            
            <div id="receipt-area-pc" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#FFF8F9] relative">
                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 pointer-events-none opacity-50">
                    <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                    <span class="text-sm">ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë¼ìš”</span>
                </div>
            </div>

            <div class="p-6 bg-white border-t-2 border-pink-100">
                <div class="flex justify-between items-end">
                    <span class="text-gray-400 text-sm font-medium">ìµœì¢… í•©ê³„</span>
                    <div class="text-right">
                        <strong class="text-3xl font-black text-gray-800 tracking-tight" id="grandTotalDisplayPC">0</strong>
                        <span class="font-bold text-gray-500">ì›</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <div class="fixed bottom-0 left-0 w-full bg-white mobile-sticky-bar z-50 lg:hidden border-t border-pink-200">
        <div class="flex items-center justify-between p-4">
            <div>
                <div class="text-xs text-gray-400 font-bold mb-1">ì´ ì˜ˆìƒ ê¸ˆì•¡</div>
                <div class="flex items-end gap-1">
                    <strong class="text-2xl font-black text-gray-800 leading-none" id="grandTotalDisplayMobile">0</strong>
                    <span class="text-sm font-bold text-gray-500">ì›</span>
                </div>
            </div>
            <div class="flex gap-2">
                 <button onclick="toggleMobileReceipt()" class="btn-bounce bg-blue-50 text-blue-600 border border-blue-100 w-12 h-12 flex items-center justify-center rounded-xl font-bold shadow-sm">
                    <i class="fa-solid fa-receipt text-xl"></i>
                </button>
                <button onclick="copyToClipboard()" class="btn-bounce bg-gray-800 text-white px-5 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm">
                    <i class="fa-regular fa-copy"></i> ë³µì‚¬
                </button>
            </div>
        </div>
    </div>

    <div id="mobileReceiptModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex flex-col justify-end transition-opacity duration-200">
        <div class="bg-white rounded-t-[2rem] h-[85vh] flex flex-col shadow-2xl overflow-hidden transform transition-transform duration-300 translate-y-full" id="mobileReceiptContent">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-700 ml-2"><i class="fa-solid fa-receipt text-blue-400"></i> ìƒì„¸ ë‚´ì—­</h3>
                <button onclick="toggleMobileReceipt()" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 hover:bg-gray-300 mr-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="receipt-area-mobile" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#FFF8F9]">
                </div>
            <div class="p-4 bg-white border-t border-gray-200 pb-8">
                <button onclick="copyToClipboard()" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg text-lg active:scale-95 transition-transform">
                    <i class="fa-regular fa-copy mr-2"></i> ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬
                </button>
            </div>
        </div>
    </div>

    <script>
        let cartIdCounter = 0;
        let globalReceiptData = {};

        document.addEventListener('DOMContentLoaded', () => {
            addCart();
        });

        function updateCartNumbers() {
            document.querySelectorAll('.cart-box').forEach((cart, index) => {
                const badge = cart.querySelector('.cart-number-badge');
                if (badge) badge.innerText = index + 1;
            });
        }

        // --- UI ìƒì„± ---
        function addCart(data = null) {
            cartIdCounter++;
            const currentId = cartIdCounter;
            const container = document.getElementById('cartsContainer');
            
            const cartHTML = `
                <div class="cart-box bg-white p-4 md:p-6 rounded-3xl card-shadow relative group transition-all" id="cart-${currentId}">
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <div class="flex-grow flex items-center gap-2 md:gap-3">
                            <div class="cart-number-badge bg-yellow-100 text-yellow-600 w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold text-xs md:text-sm border border-yellow-200 shadow-sm flex-shrink-0">1</div>
                            <input type="text" placeholder="ì¹´íŠ¸ ì´ë¦„ (ì˜ˆ: ë§ˆìŠ¤ì½”íŠ¸)" class="cart-title text-lg md:text-xl font-bold text-gray-700 bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-pink-300 focus:outline-none transition w-full placeholder-gray-300" value="${data ? data.title : ''}" oninput="calculateAll()">
                        </div>
                        <button onclick="removeCart(${currentId})" class="text-gray-300 hover:text-red-400 bg-gray-50 hover:bg-red-50 w-8 h-8 rounded-full transition flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-trash-can"></i></button>
                    </div>

                    <div class="hidden md:flex gap-3 text-xs text-gray-400 font-bold mb-3 px-2">
                        <span class="flex-[2]"><i class="fa-solid fa-tag mr-1"></i> í’ˆëª©ëª…</span>
                        <span class="flex-[2]"><i class="fa-solid fa-users mr-1"></i> êµ¬ë§¤ì</span>
                        <span class="w-24 text-center">ìˆ˜ëŸ‰</span>
                        <span class="w-32 text-center">ë‹¨ê°€(ì—”)</span>
                        <span class="w-8"></span>
                    </div>

                    <div class="space-y-4 md:space-y-3 mb-6" id="items-${currentId}"></div>
                    
                    <button onclick="addItem(${currentId})" class="w-full py-3 border border-blue-100 bg-blue-50 text-blue-500 rounded-2xl hover:bg-blue-100 font-bold text-sm transition flex items-center justify-center gap-2 mb-6">
                        <i class="fa-solid fa-plus"></i> í’ˆëª© ì¶”ê°€
                    </button>

                    <div class="bg-gray-50 p-4 md:p-5 rounded-2xl border border-gray-100 flex flex-col md:flex-row items-center justify-between gap-3">
                        <div class="input-group w-full md:w-auto">
                            <input type="number" class="shipping-cost text-right font-bold text-gray-700" placeholder="0" value="${data ? data.shipping : 0}" oninput="calculateAll()">
                            <span>ì—” (ë°°ì†¡ë¹„)</span>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-2 w-full md:w-auto justify-end">
                            <span class="bg-indigo-100 text-indigo-600 px-2 py-1 rounded-lg font-bold whitespace-nowrap">íƒ‘ìŠ¹ <span id="user-count-${currentId}">0</span>ëª…</span>
                            <span>1ì¸ <strong class="text-indigo-500 text-sm" id="ship-per-${currentId}">0</strong>ì›</span>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cartHTML);

            if (data) {
                data.items.forEach(item => addItem(currentId, item));
            } else {
                addItem(currentId);
            }
            updateCartNumbers();
            calculateAll();
        }

        function addItem(cartId, data = null) {
            const itemsContainer = document.getElementById(`items-${cartId}`);
            const itemHTML = `
                <div class="item-row flex flex-col md:flex-row gap-2 md:gap-3 items-stretch md:items-center bg-white md:bg-transparent md:p-0 rounded-2xl md:rounded-none relative group/item">
                    
                    <div class="md:hidden text-[11px] text-gray-400 font-bold mb-1 flex justify-between px-1">
                        <span>í’ˆëª© ì…ë ¥</span>
                        <button onclick="this.closest('.item-row').remove(); calculateAll()" class="text-red-400 flex items-center gap-1"><i class="fa-solid fa-trash-can"></i> ì‚­ì œ</button>
                    </div>

                    <div class="input-group w-full md:flex-[2]">
                        <input type="text" placeholder="í’ˆëª© ì´ë¦„" class="item-name text-sm" value="${data ? data.name : ''}" oninput="calculateAll()">
                    </div>
                    
                    <div class="input-group w-full md:flex-[2]">
                        <input type="text" placeholder="êµ¬ë§¤ì (ì˜ˆ: ë†ë‹´ê³°2)" class="item-buyers text-sm bg-yellow-50/30" value="${data ? data.buyers : ''}" oninput="calculateAll()">
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <div class="input-group w-full md:w-24 relative qty-group">
                            <input type="number" placeholder="1" class="item-qty text-center font-bold text-gray-600" value="${data ? data.qty : 1}" min="1" oninput="calculateAll()">
                            <span class="md:hidden">ê°œ</span>
                            <div class="warning-msg hidden absolute top-full left-0 bg-red-500 text-white text-[10px] px-2 py-1 rounded z-10 w-full text-center mt-1"></div>
                        </div>
                        <div class="input-group w-full md:w-32">
                            <input type="number" placeholder="0" class="item-price text-right font-bold text-gray-600" value="${data ? data.price : ''}" oninput="calculateAll()">
                            <span class="md:hidden">ì—”</span>
                        </div>
                    </div>
                    
                    <button onclick="this.closest('.item-row').remove(); calculateAll()" class="hidden md:flex text-gray-300 hover:text-red-400 w-8 h-8 items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `;
            itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
        }

        // --- í•µì‹¬ ê³„ì‚° ë¡œì§ (V9: ìˆ˜ëŸ‰ ë¶ˆì¼ì¹˜ ê²€ì¦ ì¶”ê°€) ---
        function calculateAll() {
            const rateStr = document.getElementById('exchangeRate').value;
            const rate = (rateStr === '' ? 0 : parseFloat(rateStr)) / 100;
            
            let grandTotalKRW = 0;
            let personReceipts = {}; 
            
            const carts = document.querySelectorAll('.cart-box');
            if (!carts) return;

            carts.forEach(cart => {
                const cartId = cart.id.split('-')[1];
                const badge = cart.querySelector('.cart-number-badge');
                const cartTitle = cart.querySelector('.cart-title').value || `ì¹´íŠ¸ ${badge ? badge.innerText : ''}`;
                const shipStr = cart.querySelector('.shipping-cost').value;
                const shippingJPY = shipStr === '' ? 0 : parseFloat(shipStr);
                
                let cartUsers = new Set();
                let cartItemsTotalJPY = 0;

                cart.querySelectorAll('.item-row').forEach(row => {
                    const iName = row.querySelector('.item-name').value.trim() || 'í’ˆëª© ë¯¸ì…ë ¥';
                    const rawBuyers = row.querySelector('.item-buyers').value;
                    const qtyStr = row.querySelector('.item-qty').value;
                    const totalRowQty = qtyStr === '' ? 1 : parseFloat(qtyStr);
                    const priceStr = row.querySelector('.item-price').value;
                    const unitPriceJPY = priceStr === '' ? 0 : parseFloat(priceStr);
                    
                    let buyerList = [];
                    let rawList = rawBuyers.split(/[,/]+/).filter(b => b.trim() !== '');

                    if (rawList.length === 0) {
                        buyerList.push({ name: 'ë¯¸ì§€ì •', q: 1 });
                    } else {
                        rawList.forEach(raw => {
                            let trimmed = raw.trim();
                            let match = trimmed.match(/^(.+?)\s*(\d+)$/);
                            if (match) {
                                buyerList.push({ name: match[1].trim(), q: parseInt(match[2]) });
                            } else {
                                buyerList.push({ name: trimmed, q: 1 });
                            }
                        });
                    }

                    // --- [V9] ìˆ˜ëŸ‰ ê²€ì¦ ë¡œì§ ---
                    let assignedTotal = 0;
                    buyerList.forEach(b => assignedTotal += b.q);

                    const qtyGroup = row.querySelector('.qty-group');
                    const warningMsg = qtyGroup.querySelector('.warning-msg');
                    
                    // ì´ ìˆ˜ëŸ‰ != ë°°ì •ëœ ìˆ˜ëŸ‰ í•©ê³„ ì´ë©´ ê²½ê³  (ë‹¨, ë¯¸ì§€ì •ì´ ì•„ë‹ë•Œë§Œ)
                    if (rawList.length > 0 && assignedTotal !== totalRowQty) {
                        qtyGroup.classList.add('error');
                        warningMsg.classList.remove('hidden');
                        warningMsg.innerText = `âš  ${assignedTotal}ëª…(ê°œ) ë°°ì •ë¨`;
                    } else {
                        qtyGroup.classList.remove('error');
                        warningMsg.classList.add('hidden');
                    }
                    // --------------------------

                    const rowTotalPriceJPY = unitPriceJPY * totalRowQty;
                    cartItemsTotalJPY += rowTotalPriceJPY;

                    let totalShares = 0;
                    buyerList.forEach(b => { totalShares += b.q; cartUsers.add(b.name); });

                    buyerList.forEach(b => {
                        const shares = totalShares > 0 ? totalShares : 1;
                        let myShareRatio = b.q / shares;
                        let myCostJPY = rowTotalPriceJPY * myShareRatio;
                        let myCostKRW = Math.round(myCostJPY * rate);

                        if(!personReceipts[b.name]) personReceipts[b.name] = { items: [], shipping: 0, total: 0 };
                        personReceipts[b.name].items.push({ cart: cartTitle, name: iName, desc: `${b.q}ê°œ`, cost: myCostKRW });
                        personReceipts[b.name].total += myCostKRW;
                    });
                });

                const realUsers = [...cartUsers].filter(u => u !== 'ë¯¸ì§€ì •');
                const userCount = realUsers.length > 0 ? realUsers.length : 1;
                const shippingKRW = Math.round(shippingJPY * rate);
                const shipPerPerson = Math.round(shippingKRW / userCount);

                const uCountEl = document.getElementById(`user-count-${cartId}`);
                const sPerEl = document.getElementById(`ship-per-${cartId}`);
                if(uCountEl) uCountEl.innerText = userCount;
                if(sPerEl) sPerEl.innerText = shipPerPerson.toLocaleString();

                realUsers.forEach(u => {
                    if(personReceipts[u]) {
                        personReceipts[u].shipping += shipPerPerson;
                        personReceipts[u].total += shipPerPerson;
                    }
                });
                grandTotalKRW += (cartItemsTotalJPY * rate) + shippingKRW;
            });

            globalReceiptData = personReceipts;
            renderReceipts(personReceipts);
            
            const totalStr = Math.round(grandTotalKRW).toLocaleString();
            const pcTotal = document.getElementById('grandTotalDisplayPC');
            const mobileTotal = document.getElementById('grandTotalDisplayMobile');
            
            if(pcTotal) pcTotal.innerText = totalStr;
            if(mobileTotal) mobileTotal.innerText = totalStr;
        }

        function renderReceipts(data) {
            const containers = [document.getElementById('receipt-area-pc'), document.getElementById('receipt-area-mobile')];
            containers.forEach(container => {
                if(!container) return;
                container.innerHTML = '';
                if(Object.keys(data).length === 0) {
                     container.innerHTML = `<div class="flex flex-col items-center justify-center text-gray-300 py-10"><i class="fa-solid fa-basket-shopping text-3xl mb-2"></i><span class="text-sm">ë¹„ì–´ìˆìŒ</span></div>`;
                    return;
                }
                for (const [name, info] of Object.entries(data)) {
                    if (name === 'ë¯¸ì§€ì •' && info.total === 0) continue;
                    const itemRows = info.items.map(i => `
                        <div class="flex justify-between items-start text-xs text-gray-500 mb-1.5 last:mb-0">
                            <div><span class="block text-gray-700 font-medium">${i.name}</span><span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded mr-1">${i.cart}</span><span class="text-[10px] text-gray-400">${i.desc}</span></div>
                            <span class="font-bold text-gray-600 whitespace-nowrap">${i.cost.toLocaleString()}</span>
                        </div>
                    `).join('');
                    const html = `
                        <div class="bg-white border border-gray-100 rounded-xl p-4 receipt-shadow relative overflow-hidden mb-3">
                            <div class="absolute top-0 left-0 w-1 h-full bg-${getColor(name)}"></div>
                            <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-3">
                                <span class="font-bold text-gray-800 text-sm flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></span>${name}</span>
                                <span class="font-black text-lg text-indigo-500">${info.total.toLocaleString()}ì›</span>
                            </div>
                            <div class="space-y-1 mb-3">${itemRows}</div>
                            ${info.shipping > 0 ? `<div class="flex justify-between items-center text-xs text-blue-500 font-bold pt-2 border-t border-dashed border-gray-200"><span><i class="fa-solid fa-truck-fast"></i> ë°°ì†¡ë¹„ ë¶„ë‹´</span><span>+${info.shipping.toLocaleString()}ì›</span></div>` : ''}
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                }
            });
        }
        
        function getColor(name) {
            const colors = ['pink-300', 'blue-300', 'yellow-300', 'green-300', 'purple-300'];
            return colors[name.length % colors.length];
        }

        // --- ëª¨ë°”ì¼ ê¸°ëŠ¥ ---
        function toggleMobileReceipt() {
            const modal = document.getElementById('mobileReceiptModal');
            const content = document.getElementById('mobileReceiptContent');
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => content.classList.remove('translate-y-full'), 10);
            } else {
                content.classList.add('translate-y-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function copyToClipboard() {
            let text = `[ğŸ± ì¹˜ì´ì¹´ì™€ ê³µêµ¬ ì •ì‚°ì„œ]\nğŸ“… ${new Date().toLocaleDateString()}\n\n`;
            const data = globalReceiptData;
            if(!data || Object.keys(data).length === 0) { alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"); return; }
            for (const [name, info] of Object.entries(data)) {
                if (name === 'ë¯¸ì§€ì •' && info.total === 0) continue;
                text += `ğŸ‘¤ ${name}ë‹˜\n`;
                info.items.forEach(i => { text += `- ${i.name} (${i.desc}): ${i.cost.toLocaleString()}ì›\n`; });
                if(info.shipping > 0) text += `ğŸšš ë°°ì†¡ë¹„: ${info.shipping.toLocaleString()}ì›\n`;
                text += `ğŸ’° ì…ê¸ˆì•¡: ${info.total.toLocaleString()}ì›\n`;
                text += `--------------------\n`;
            }
            text += `\nì´ í•©ê³„: ${document.getElementById('grandTotalDisplayPC')?.innerText || '0'}ì›`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert("âœ¨ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!")).catch(() => fallbackCopy(text));
            } else { fallbackCopy(text); }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea); textArea.focus(); textArea.select();
            try { document.execCommand('copy'); alert("âœ¨ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); } 
            catch (err) { alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ’¦"); }
            document.body.removeChild(textArea);
        }

        function removeCart(id) {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const cart = document.getElementById(`cart-${id}`);
                cart.style.transform = 'scale(0.9)'; cart.style.opacity = '0';
                setTimeout(() => {
                    cart.remove();
                    if(document.querySelectorAll('.cart-box').length === 0) addCart();
                    updateCartNumbers(); calculateAll();
                }, 200);
            }
        }

        function saveData() {
            const data = { rate: document.getElementById('exchangeRate').value, carts: [] };
            document.querySelectorAll('.cart-box').forEach(cart => {
                const cartData = {
                    title: cart.querySelector('.cart-title').value,
                    shipping: cart.querySelector('.shipping-cost').value,
                    items: []
                };
                cart.querySelectorAll('.item-row').forEach(row => {
                    cartData.items.push({
                        name: row.querySelector('.item-name').value,
                        buyers: row.querySelector('.item-buyers').value,
                        qty: row.querySelector('.item-qty').value,
                        price: row.querySelector('.item-price').value
                    });
                });
                data.carts.push(cartData);
            });
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `chiikawa_gonggu_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function loadData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    cartIdCounter = 0; 
                    document.getElementById('exchangeRate').value = data.rate || 900;
                    document.getElementById('cartsContainer').innerHTML = '';
                    data.carts.forEach(c => addCart(c));
                    updateCartNumbers(); calculateAll();
                    alert("ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
                } catch(err) { alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            };
            reader.readAsText(file);
            input.value='';
        }
    </script>
</body>
</html>
