<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹˜ì´ì¹´ì™€ ê³µêµ¬ ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        :root {
            --chii-pink: #FFB7B2;
            --chii-dark-pink: #FF9AA2;
            --hachi-blue: #AECBFA;
            --usa-yellow: #FFF9C4;
            --bg-color: #FFF8F9;
        }

        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: #4A4A4A; }
        
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #fff; }
        ::-webkit-scrollbar-thumb { background: var(--chii-pink); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--chii-dark-pink); }

        /* ê·¸ë¦¼ì ë° ì¹´ë“œ íš¨ê³¼ */
        .soft-shadow { box-shadow: 0 4px 20px rgba(255, 183, 178, 0.3); }
        .card-shadow { box-shadow: 4px 4px 0px var(--chii-pink); border: 2px solid #6D6D6D; }
        .receipt-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* ì…ë ¥ì°½ ì¸í„°ë™ì…˜ */
        .input-cute {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            transition: all 0.2s;
            background-color: #FAFAFA;
        }
        .input-cute:focus {
            border-color: var(--chii-dark-pink);
            background-color: #FFF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 154, 162, 0.2);
        }

        /* ë²„íŠ¼ íš¨ê³¼ */
        .btn-bounce { transition: transform 0.1s; }
        .btn-bounce:active { transform: scale(0.95); }

        /* ì˜ìˆ˜ì¦ ì¢…ì´ ì§ˆê° */
        .receipt-paper {
            background-image: radial-gradient(#F3F4F6 1px, transparent 0);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-pink-100 selection:text-pink-600">

    <header class="bg-white/80 backdrop-blur-md border-b-2 border-pink-100 z-30 px-4 py-3 flex-none soft-shadow">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center text-pink-500 text-xl border-2 border-pink-200">
                    <i class="fa-solid fa-heart"></i>
                </div>
                <h1 class="text-2xl font-black text-gray-700 tracking-tight">ì¹˜ì´ì¹´ì™€ ê³µêµ¬ ë§¤ë‹ˆì €</h1>
                
                <div class="ml-4 bg-yellow-50 px-4 py-1.5 rounded-full border border-yellow-200 flex items-center shadow-sm">
                    <span class="text-xs font-bold text-yellow-600 mr-2">ì ìš© í™˜ìœ¨</span>
                    <input type="number" id="exchangeRate" value="900" class="bg-transparent w-14 text-right font-bold text-gray-700 outline-none border-b border-yellow-300 focus:border-yellow-500" oninput="calculateAll()">
                    <span class="text-xs text-gray-500 ml-1">ì›</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="saveData()" class="btn-bounce bg-green-100 text-green-700 border border-green-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-green-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-download"></i> ì €ì¥
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-bounce bg-blue-100 text-blue-700 border border-blue-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-folder-open"></i> ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadData(this)">
            </div>
        </div>
    </header>

    <div class="flex-grow flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto w-full">
        
        <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6" id="main-scroll">
            <div id="cartsContainer" class="space-y-8 pb-10"></div>
            
            <div class="text-center pb-20">
                <button onclick="addCart()" class="btn-bounce w-full md:w-2/3 mx-auto bg-white border-2 border-dashed border-pink-200 text-pink-400 px-6 py-5 rounded-3xl hover:bg-pink-50 hover:border-pink-300 transition font-bold text-lg shadow-sm flex flex-col items-center gap-2">
                    <i class="fa-solid fa-circle-plus text-2xl"></i>
                    <span>ìƒˆë¡œìš´ ì¹´íŠ¸(ê³µêµ¬ ê·¸ë£¹) ì¶”ê°€</span>
                </button>
            </div>
        </main>

        <aside class="w-full lg:w-[380px] bg-white border-l border-gray-100 flex flex-col shadow-2xl z-20 h-[45vh] lg:h-auto">
            <div class="p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-blue-400"></i> ì •ì‚° ë‚´ì—­ì„œ
                    </h2>
                    <p class="text-xs text-gray-400 mt-1">ì´ë¦„ ë’¤ì— ìˆ«ìë¡œ ìˆ˜ëŸ‰ ì§€ì • ê°€ëŠ¥ (ì˜ˆ: ë†ë‹´ê³°2)</p>
                </div>
                <button onclick="copyToClipboard()" class="btn-bounce bg-gray-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-900 shadow-lg flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> ë³µì‚¬
                </button>
            </div>
            
            <div id="receipt-area" class="flex-1 overflow-y-auto p-4 space-y-4 receipt-paper relative">
                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 pointer-events-none opacity-50">
                    <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                    <span class="text-sm">ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤</span>
                </div>
            </div>

            <div class="p-6 bg-white border-t-2 border-pink-100 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
                <div class="flex justify-between items-end">
                    <span class="text-gray-400 text-sm font-medium">ìµœì¢… ê²°ì œ ì˜ˆì • ê¸ˆì•¡</span>
                    <div class="text-right">
                        <strong class="text-3xl font-black text-gray-800 tracking-tight" id="grandTotalDisplay">0</strong>
                        <span class="font-bold text-gray-500">ì›</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        let cartIdCounter = 0;
        let globalReceiptData = {}; // ë³µì‚¬ ê¸°ëŠ¥ì„ ìœ„í•œ ë°ì´í„° ì €ì¥ì†Œ

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì¹´íŠ¸ í•˜ë‚˜ ìƒì„±
        document.addEventListener('DOMContentLoaded', () => {
            addCart();
        });

        // --- 1. UI ìƒì„± í•¨ìˆ˜ë“¤ ---
        function addCart(data = null) {
            cartIdCounter++;
            const currentId = cartIdCounter;
            const container = document.getElementById('cartsContainer');
            
            const cartHTML = `
                <div class="cart-box bg-white p-6 rounded-[2rem] card-shadow relative group transition-all" id="cart-${currentId}">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex-grow flex items-center gap-3">
                            <div class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border border-yellow-200 shadow-sm">${currentId}</div>
                            <input type="text" placeholder="ì˜ˆ: ë§ˆì¼“ ì‹ ìƒ ê³µêµ¬" class="cart-title text-xl font-bold text-gray-700 bg-transparent border-b-2 border-transparent hover:border-gray-200 focus:border-pink-300 focus:outline-none transition w-full placeholder-gray-300" value="${data ? data.title : ''}" oninput="calculateAll()">
                        </div>
                        <button onclick="removeCart(${currentId})" class="text-gray-300 hover:text-red-400 bg-gray-50 hover:bg-red-50 w-8 h-8 rounded-full transition flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                    </div>

                    <div class="hidden md:flex gap-3 text-xs text-gray-400 font-bold mb-3 px-2">
                        <span class="flex-[2]"><i class="fa-solid fa-tag mr-1"></i> í’ˆëª©ëª…</span>
                        <span class="flex-[2]"><i class="fa-solid fa-users mr-1"></i> êµ¬ë§¤ì (ì˜ˆ: ë†ë‹´ê³°2, ìš°ì‚¬ê¸°1)</span>
                        <span class="w-16 text-center">ì´ ìˆ˜ëŸ‰</span>
                        <span class="w-28 text-right">ë‹¨ê°€(ì—”)</span>
                        <span class="w-8"></span>
                    </div>

                    <div class="space-y-3 mb-5" id="items-${currentId}"></div>
                    
                    <button onclick="addItem(${currentId})" class="w-full py-3 border border-blue-100 bg-blue-50 text-blue-500 rounded-2xl hover:bg-blue-100 font-bold text-sm transition flex items-center justify-center gap-2 mb-6">
                        <i class="fa-solid fa-plus"></i> í’ˆëª© ì¶”ê°€í•˜ê¸°
                    </button>

                    <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-3 bg-white px-3 py-2 rounded-xl border border-gray-200 shadow-sm">
                            <label class="text-xs font-bold text-gray-500">ë°°ì†¡ë¹„(ì—”)</label>
                            <input type="number" class="shipping-cost w-20 text-right font-bold text-gray-700 outline-none bg-transparent" placeholder="0" value="${data ? data.shipping : 0}" oninput="calculateAll()">
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-2">
                            <span class="bg-indigo-100 text-indigo-600 px-2 py-1 rounded-lg font-bold">íƒ‘ìŠ¹ <span id="user-count-${currentId}">0</span>ëª…</span>
                            <span>1ì¸ë‹¹ <strong class="text-indigo-500 text-sm" id="ship-per-${currentId}">0</strong>ì› ë¶€ë‹´</span>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cartHTML);

            if (data) {
                data.items.forEach(item => addItem(currentId, item));
            } else {
                addItem(currentId);
            }
            calculateAll();
        }

        function addItem(cartId, data = null) {
            const itemsContainer = document.getElementById(`items-${cartId}`);
            const itemHTML = `
                <div class="item-row flex flex-col md:flex-row gap-3 items-start md:items-center bg-gray-50 md:bg-transparent p-4 md:p-0 rounded-2xl md:rounded-none border md:border-none border-gray-100 relative group/item">
                    <input type="text" placeholder="í’ˆëª© ì´ë¦„" class="item-name flex-[2] w-full input-cute px-3 py-2.5 text-sm" value="${data ? data.name : ''}" oninput="calculateAll()">
                    
                    <div class="flex-[2] w-full relative">
                        <input type="text" placeholder="ë†ë‹´ê³°2, ìš°ì‚¬ê¸°1 (ë¯¸ì…ë ¥ì‹œ 1ê°œ)" class="item-buyers w-full input-cute px-3 py-2.5 text-sm bg-yellow-50/50 focus:bg-white" value="${data ? data.buyers : ''}" oninput="calculateAll()">
                        <i class="fa-solid fa-pen absolute right-3 top-3 text-gray-300 text-xs pointer-events-none"></i>
                    </div>
                    
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="number" placeholder="ì´ ìˆ˜ëŸ‰" class="item-qty w-full md:w-16 input-cute px-2 py-2.5 text-sm text-center font-bold text-gray-600" value="${data ? data.qty : 1}" min="1" oninput="calculateAll()">
                        <input type="number" placeholder="ê°€ê²©" class="item-price w-full md:w-28 input-cute px-3 py-2.5 text-sm text-right font-bold text-gray-600" value="${data ? data.price : ''}" oninput="calculateAll()">
                    </div>
                    
                    <button onclick="this.closest('.item-row').remove(); calculateAll()" class="hidden md:flex text-gray-300 hover:text-red-400 w-8 h-8 items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fa-solid fa-xmark"></i></button>
                    <button onclick="this.closest('.item-row').remove(); calculateAll()" class="md:hidden w-full text-red-500 text-xs py-3 bg-red-50 border border-red-100 rounded-xl mt-1 font-bold shadow-sm active:bg-red-100">ì´ í’ˆëª© ì‚­ì œí•˜ê¸°</button>
                </div>
            `;
            itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
        }

        // --- 2. í•µì‹¬ ê³„ì‚° ë¡œì§ (ìŠ¤ë§ˆíŠ¸ ë¶„ë°° + ì˜¤ë¥˜ ë°©ì§€) ---
        function calculateAll() {
            // í™˜ìœ¨ ì˜¤ë¥˜ ë°©ì§€
            const rateStr = document.getElementById('exchangeRate').value;
            const rate = (rateStr === '' ? 0 : parseFloat(rateStr)) / 100;
            
            let grandTotalKRW = 0;
            let personReceipts = {}; 
            
            document.querySelectorAll('.cart-box').forEach(cart => {
                const cartId = cart.id.split('-')[1];
                const cartTitle = cart.querySelector('.cart-title').value || `ì¹´íŠ¸ ${cartId}`;
                const shipStr = cart.querySelector('.shipping-cost').value;
                const shippingJPY = shipStr === '' ? 0 : parseFloat(shipStr);
                
                let cartUsers = new Set();
                let cartItemsTotalJPY = 0;

                cart.querySelectorAll('.item-row').forEach(row => {
                    const iName = row.querySelector('.item-name').value.trim() || 'í’ˆëª© ë¯¸ì…ë ¥';
                    const rawBuyers = row.querySelector('.item-buyers').value;
                    
                    // ìˆ˜ëŸ‰/ê°€ê²© ë¹ˆê°’ ì²˜ë¦¬ (NaN ë°©ì§€)
                    const qtyStr = row.querySelector('.item-qty').value;
                    const totalRowQty = qtyStr === '' ? 1 : parseFloat(qtyStr);
                    
                    const priceStr = row.querySelector('.item-price').value;
                    const unitPriceJPY = priceStr === '' ? 0 : parseFloat(priceStr);
                    
                    // --- êµ¬ë§¤ì íŒŒì‹± (ì´ë¦„ + ìˆ˜ëŸ‰) ---
                    let buyerList = [];
                    // ì½¤ë§ˆ, ìŠ¬ë˜ì‹œ ë“±ìœ¼ë¡œ ë¶„ë¦¬
                    let rawList = rawBuyers.split(/[,/]+/).filter(b => b.trim() !== '');

                    if (rawList.length === 0) {
                        buyerList.push({ name: 'ë¯¸ì§€ì •', q: 1 });
                    } else {
                        rawList.forEach(raw => {
                            let trimmed = raw.trim();
                            // ì •ê·œì‹: ì´ë¦„ ë’¤ì— ë¶™ì€ ìˆ«ì ì¶”ì¶œ (ì˜ˆ: "í•˜ì¹˜ì™€ë ˆ 2")
                            let match = trimmed.match(/^(.+?)\s*(\d+)$/);
                            if (match) {
                                buyerList.push({ name: match[1].trim(), q: parseInt(match[2]) });
                            } else {
                                // ìˆ«ìê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ 1ê°œë¡œ ê°„ì£¼
                                buyerList.push({ name: trimmed, q: 1 });
                            }
                        });
                    }

                    // --- ë¹„ìš© ë¶„ë°° ---
                    const rowTotalPriceJPY = unitPriceJPY * totalRowQty;
                    cartItemsTotalJPY += rowTotalPriceJPY;

                    // ì´ ì¤„(Item)ì˜ ì´ ì§€ë¶„ ê³„ì‚°
                    let totalShares = 0;
                    buyerList.forEach(b => {
                        totalShares += b.q;
                        cartUsers.add(b.name);
                    });

                    // ê°œì¸ë³„ ë¹„ìš© í• ë‹¹
                    buyerList.forEach(b => {
                        // ì§€ë¶„ì´ 0ì´ë©´(í˜¹ì‹œ ëª¨ë¥¼ ì˜¤ë¥˜) 1ë¡œ ì²˜ë¦¬
                        const shares = totalShares > 0 ? totalShares : 1;
                        let myShareRatio = b.q / shares;
                        let myCostJPY = rowTotalPriceJPY * myShareRatio;
                        let myCostKRW = Math.round(myCostJPY * rate);

                        if(!personReceipts[b.name]) personReceipts[b.name] = { items: [], shipping: 0, total: 0 };
                        
                        personReceipts[b.name].items.push({
                            cart: cartTitle,
                            name: iName,
                            desc: `${b.q}ê°œ`, // ì˜ìˆ˜ì¦ì—ëŠ” "2ê°œ" ì²˜ëŸ¼ ë³¸ì¸ ëª«ë§Œ ê¹”ë”í•˜ê²Œ í‘œì‹œ
                            cost: myCostKRW
                        });
                        personReceipts[b.name].total += myCostKRW;
                    });
                });

                // --- ë°°ì†¡ë¹„ ê³„ì‚° ---
                const realUsers = [...cartUsers].filter(u => u !== 'ë¯¸ì§€ì •');
                const userCount = realUsers.length > 0 ? realUsers.length : 1;
                
                const shippingKRW = Math.round(shippingJPY * rate);
                const shipPerPerson = Math.round(shippingKRW / userCount);

                document.getElementById(`user-count-${cartId}`).innerText = userCount;
                document.getElementById(`ship-per-${cartId}`).innerText = shipPerPerson.toLocaleString();

                realUsers.forEach(u => {
                    if(personReceipts[u]) {
                        personReceipts[u].shipping += shipPerPerson;
                        personReceipts[u].total += shipPerPerson;
                    }
                });

                grandTotalKRW += (cartItemsTotalJPY * rate) + shippingKRW;
            });

            globalReceiptData = personReceipts;
            renderReceipts(personReceipts);
            document.getElementById('grandTotalDisplay').innerText = Math.round(grandTotalKRW).toLocaleString();
        }

        // --- 3. ì˜ìˆ˜ì¦ ë Œë”ë§ ---
        function renderReceipts(data) {
            const container = document.getElementById('receipt-area');
            container.innerHTML = '';
            
            if(Object.keys(data).length === 0) {
                 container.innerHTML = `
                <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 pointer-events-none opacity-50">
                    <i class="fa-solid fa-basket-shopping text-4xl mb-2"></i>
                    <span class="text-sm">ì…ë ¥ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤</span>
                </div>`;
                return;
            }

            for (const [name, info] of Object.entries(data)) {
                if (name === 'ë¯¸ì§€ì •' && info.total === 0) continue;

                const itemRows = info.items.map(i => `
                    <div class="flex justify-between items-start text-xs text-gray-500 mb-1.5 last:mb-0">
                        <div>
                            <span class="block text-gray-700 font-medium">${i.name}</span>
                            <span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">${i.cart}</span>
                            <span class="text-[10px] text-gray-400">${i.desc}</span>
                        </div>
                        <span class="font-bold text-gray-600 whitespace-nowrap">${i.cost.toLocaleString()}</span>
                    </div>
                `).join('');

                const html = `
                    <div class="bg-white border border-gray-100 rounded-xl p-4 receipt-shadow relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-${getColor(name)}"></div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-3">
                            <span class="font-bold text-gray-800 text-sm flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></span>
                                ${name}
                            </span>
                            <span class="font-black text-lg text-indigo-500">${info.total.toLocaleString()}ì›</span>
                        </div>
                        <div class="space-y-1 mb-3">
                            ${itemRows}
                        </div>
                        ${info.shipping > 0 ? `
                        <div class="flex justify-between items-center text-xs text-blue-500 font-bold pt-2 border-t border-dashed border-gray-200">
                            <span class="flex items-center gap-1"><i class="fa-solid fa-truck-fast"></i> ë°°ì†¡ë¹„ ë¶„ë‹´</span>
                            <span>+${info.shipping.toLocaleString()}ì›</span>
                        </div>` : ''}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
        }
        
        // ì¹´ë“œ ìƒ‰ìƒ ëœë¤ ìƒì„±
        function getColor(name) {
            const colors = ['pink-300', 'blue-300', 'yellow-300', 'green-300', 'purple-300'];
            return colors[name.length % colors.length];
        }

        // --- 4. ìœ í‹¸ë¦¬í‹° (ì‚­ì œ, ë³µì‚¬, ì €ì¥, ë¡œë“œ) ---
        function removeCart(id) {
            if(confirm('ì´ ì¹´íŠ¸ë¥¼ ì •ë§ ì‚­ì œí• ê¹Œìš”?')) {
                const cart = document.getElementById(`cart-${id}`);
                // ì• ë‹ˆë©”ì´ì…˜
                cart.style.transform = 'scale(0.9)'; 
                cart.style.opacity = '0';
                
                setTimeout(() => {
                    cart.remove();
                    // ì¹´íŠ¸ê°€ ë‹¤ ì§€ì›Œì§€ë©´ ê¸°ë³¸ ì¹´íŠ¸ í•˜ë‚˜ ìƒì„±
                    if(document.querySelectorAll('.cart-box').length === 0) addCart();
                    calculateAll();
                }, 200);
            }
        }

        function copyToClipboard() {
            let text = `[ğŸ± ì¹˜ì´ì¹´ì™€ ê³µêµ¬ ì •ì‚°ì„œ]\nğŸ“… ${new Date().toLocaleDateString()}\n\n`;
            const data = globalReceiptData;
            
            if(!data || Object.keys(data).length === 0) { alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ’¦"); return; }
            
            let hasContent = false;
            for (const [name, info] of Object.entries(data)) {
                if (name === 'ë¯¸ì§€ì •' && info.total === 0) continue;
                hasContent = true;
                
                text += `ğŸ‘¤ ${name}ë‹˜\n`;
                info.items.forEach(i => { text += `- ${i.name} (${i.desc}): ${i.cost.toLocaleString()}ì›\n`; });
                if(info.shipping > 0) text += `ğŸšš ë°°ì†¡ë¹„: ${info.shipping.toLocaleString()}ì›\n`;
                text += `ğŸ’° ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡: ${info.total.toLocaleString()}ì›\n`;
                text += `--------------------\n`;
            }
            
            if(!hasContent) { alert("ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
            
            text += `\nì´ í•©ê³„: ${document.getElementById('grandTotalDisplay').innerText}ì›`;

            navigator.clipboard.writeText(text).then(() => alert("âœ¨ ì •ì‚°ì„œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
        }

        function saveData() {
            const data = { rate: document.getElementById('exchangeRate').value, carts: [] };
            document.querySelectorAll('.cart-box').forEach(cart => {
                const cartData = {
                    title: cart.querySelector('.cart-title').value,
                    shipping: cart.querySelector('.shipping-cost').value,
                    items: []
                };
                cart.querySelectorAll('.item-row').forEach(row => {
                    cartData.items.push({
                        name: row.querySelector('.item-name').value,
                        buyers: row.querySelector('.item-buyers').value,
                        qty: row.querySelector('.item-qty').value,
                        price: row.querySelector('.item-price').value
                    });
                });
                data.carts.push(cartData);
            });
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `chiikawa_gonggu_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function loadData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: ì¹´íŠ¸ ë²ˆí˜¸ ì´ˆê¸°í™” â˜…
                    cartIdCounter = 0; 
                    
                    document.getElementById('exchangeRate').value = data.rate || 900;
                    document.getElementById('cartsContainer').innerHTML = '';
                    data.carts.forEach(c => addCart(c));
                    calculateAll();
                    alert("ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ğŸ“‚");
                } catch(err) {
                    alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            };
            reader.readAsText(file);
            input.value='';
        }
    </script>
</body>
</html>